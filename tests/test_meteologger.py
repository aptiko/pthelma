#!/usr/bin/python
"""
Tests for meteologger.

Copyright (C) 2009 National Technical University of Athens

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
"""

import unittest
import textwrap
import os
from cStringIO import StringIO
import tempfile
import cookielib
from urllib2 import build_opener, HTTPCookieProcessor, Request, HTTPError
import json
import sys

from pthelma.timeseries import Timeseries
from pthelma.meteologger import Datafile_deltacom, Datafile_simple

timeseries1 = textwrap.dedent("""\
         2009-03-19T20:10,2.413333,
         2009-03-19T20:20,2.320000,
         2009-03-19T20:30,2.386667,
         2009-03-19T20:40,1.746667,
         2009-03-19T20:50,1.680000,
         2009-03-19T21:00,1.546667,
         2009-03-19T21:10,1.520000,
         2009-03-19T21:20,1.520000,
         2009-03-19T21:30,1.386667,
         2009-03-19T21:40,1.466667,
         2009-03-19T21:50,1.053333,
         2009-03-19T22:00,0.973333,
         2009-03-19T22:10,1.746667,
         2009-03-19T22:20,1.866667,
         2009-03-19T22:30,1.546667,
         2009-03-19T22:40,1.640000,
         2009-03-19T22:50,1.693333,
         2009-03-19T23:00,1.466667,
         2009-03-19T23:10,1.613333,
         2009-03-19T23:20,2.146667,
         2009-03-19T23:30,1.586667,
         2009-03-19T23:40,0.840000,
         2009-03-19T23:50,1.453333,
         2009-03-20T00:00,1.746667,
         2009-03-20T00:10,1.120000,
         2009-03-20T00:20,0.400000,
         2009-03-20T00:30,0.520000,
         2009-03-20T00:40,0.786667,
         2009-03-20T00:50,0.733333,
         2009-03-20T01:00,0.506667,
         2009-03-20T01:10,0.866667,
         2009-03-20T01:20,0.413333,
         2009-03-20T01:30,0.400000,
         2009-03-20T01:40,0.426667,
         2009-03-20T01:50,0.400000,
         2009-03-20T02:00,0.400000,
         2009-03-20T02:10,0.400000,
         2009-03-20T02:20,0.400000,
         2009-03-20T02:30,0.400000,
         2009-03-20T02:40,0.480000,
         2009-03-20T02:50,1.066667,
         2009-03-20T03:00,1.280000,
         2009-03-20T03:10,1.706667,
         2009-03-20T03:20,2.133333,
         2009-03-20T03:30,2.093333,
         2009-03-20T03:40,2.040000,
         2009-03-20T03:50,1.986667,
         2009-03-20T04:00,1.826667,
         2009-03-20T04:10,1.573333,
         2009-03-20T04:20,1.906667,
         2009-03-20T04:30,1.973333,
         2009-03-20T04:40,1.960000,
         2009-03-20T04:50,2.053333,
         2009-03-20T05:00,2.213333,
         2009-03-20T05:10,1.466667,
         2009-03-20T05:20,1.506667,
         2009-03-20T05:30,2.266667,
         2009-03-20T05:40,1.840000,
         2009-03-20T05:50,1.866667,
         2009-03-20T06:00,1.066667,
         2009-03-20T06:10,0.586667,
         2009-03-20T06:20,1.040000,
         2009-03-20T06:30,0.546667,
         2009-03-20T06:40,0.720000,
         2009-03-20T06:50,0.853333,
         2009-03-20T07:00,1.186667,
         2009-03-20T07:10,2.160000,
         2009-03-20T07:20,2.306667,
         2009-03-20T07:30,2.280000,
         2009-03-20T07:40,1.906667,
         2009-03-20T07:50,2.493333,
         2009-03-20T08:00,2.546667,
         2009-03-20T08:10,2.773333,
         2009-03-20T08:20,2.480000,
         2009-03-20T08:30,2.373333,
         2009-03-20T08:40,2.373333,
         2009-03-20T08:50,2.746667,
         2009-03-20T09:00,2.960000,
         2009-03-20T09:10,2.866667,
         2009-03-20T09:20,3.266667,
         2009-03-20T09:30,2.360000,
         2009-03-20T09:40,2.373333,
         2009-03-20T09:50,3.066667,
         2009-03-20T10:00,3.653333,
         2009-03-20T10:10,3.600000,
         2009-03-20T10:20,2.640000,
         2009-03-20T10:30,3.400000,
         2009-03-20T10:40,3.680000,
         2009-03-20T10:50,4.013333,
         2009-03-20T11:00,4.226667,
         2009-03-20T11:10,2.706667,
         2009-03-20T11:20,3.600000,
         2009-03-20T11:30,4.693333,
         2009-03-20T11:40,4.560000,
         2009-03-20T11:50,4.306667,
         2009-03-20T12:00,4.066667,
         2009-03-20T12:10,4.133333,
         2009-03-20T12:20,4.146667,
         2009-03-20T12:30,4.466667,
         2009-03-20T12:40,4.946667,
         """)

timeseries2 = textwrap.dedent("""\
         2009-03-19T20:10,2.710526,
         2009-03-19T20:20,2.578947,
         2009-03-19T20:30,2.736842,
         2009-03-19T20:40,2.210526,
         2009-03-19T20:50,2.105263,
         2009-03-19T21:00,1.947368,
         2009-03-19T21:10,2.052632,
         2009-03-19T21:20,1.921053,
         2009-03-19T21:30,1.921053,
         2009-03-19T21:40,1.973684,
         2009-03-19T21:50,1.184211,
         2009-03-19T22:00,1.631579,
         2009-03-19T22:10,2.342105,
         2009-03-19T22:20,2.815789,
         2009-03-19T22:30,2.000000,
         2009-03-19T22:40,1.842105,
         2009-03-19T22:50,1.947368,
         2009-03-19T23:00,1.710526,
         2009-03-19T23:10,2.131579,
         2009-03-19T23:20,2.421053,
         2009-03-19T23:30,2.078947,
         2009-03-19T23:40,1.500000,
         2009-03-19T23:50,2.026316,
         2009-03-20T00:00,2.078947,
         2009-03-20T00:10,1.631579,
         2009-03-20T00:20,0.421053,
         2009-03-20T00:30,1.026316,
         2009-03-20T00:40,1.342105,
         2009-03-20T00:50,1.394737,
         2009-03-20T01:00,1.026316,
         2009-03-20T01:10,1.552632,
         2009-03-20T01:20,0.684211,
         2009-03-20T01:30,0.394737,
         2009-03-20T01:40,0.763158,
         2009-03-20T01:50,0.394737,
         2009-03-20T02:00,0.394737,
         2009-03-20T02:10,0.394737,
         2009-03-20T02:20,0.394737,
         2009-03-20T02:30,0.394737,
         2009-03-20T02:40,0.842105,
         2009-03-20T02:50,2.315789,
         2009-03-20T03:00,2.947368,
         2009-03-20T03:10,2.105263,
         2009-03-20T03:20,3.131579,
         2009-03-20T03:30,2.763158,
         2009-03-20T03:40,2.842105,
         2009-03-20T03:50,3.052632,
         2009-03-20T04:00,2.842105,
         2009-03-20T04:10,2.842105,
         2009-03-20T04:20,2.921053,
         2009-03-20T04:30,2.947368,
         2009-03-20T04:40,3.157895,
         2009-03-20T04:50,2.789474,
         2009-03-20T05:00,3.078947,
         2009-03-20T05:10,3.052632,
         2009-03-20T05:20,3.263158,
         2009-03-20T05:30,2.868421,
         2009-03-20T05:40,2.578947,
         2009-03-20T05:50,2.447368,
         2009-03-20T06:00,2.026316,
         2009-03-20T06:10,1.315789,
         2009-03-20T06:20,1.500000,
         2009-03-20T06:30,1.026316,
         2009-03-20T06:40,2.000000,
         2009-03-20T06:50,1.973684,
         2009-03-20T07:00,1.710526,
         2009-03-20T07:10,3.026316,
         2009-03-20T07:20,3.131579,
         2009-03-20T07:30,3.447368,
         2009-03-20T07:40,2.815789,
         2009-03-20T07:50,4.052632,
         2009-03-20T08:00,4.026316,
         2009-03-20T08:10,3.815789,
         2009-03-20T08:20,3.842105,
         2009-03-20T08:30,3.500000,
         2009-03-20T08:40,3.605263,
         2009-03-20T08:50,3.789474,
         2009-03-20T09:00,4.078947,
         2009-03-20T09:10,4.447368,
         2009-03-20T09:20,4.500000,
         2009-03-20T09:30,3.973684,
         2009-03-20T09:40,4.789474,
         2009-03-20T09:50,4.763158,
         2009-03-20T10:00,5.421053,
         2009-03-20T10:10,5.526316,
         2009-03-20T10:20,5.052632,
         2009-03-20T10:30,6.026316,
         2009-03-20T10:40,5.184211,
         2009-03-20T10:50,6.026316,
         2009-03-20T11:00,6.631579,
         2009-03-20T11:10,5.657895,
         2009-03-20T11:20,5.131579,
         2009-03-20T11:30,7.052632,
         2009-03-20T11:40,6.078947,
         2009-03-20T11:50,6.394737,
         2009-03-20T12:00,6.236842,
         2009-03-20T12:10,5.868421,
         2009-03-20T12:20,6.394737,
         2009-03-20T12:30,6.000000,
         2009-03-20T12:40,7.184211,
         """)

deltacom_data = textwrap.dedent("""\
         2009-03-19T20:10 0.000000  2.413333  2.710526
         2009-03-19T20:20 0.000000  2.320000  2.578947
         2009-03-19T20:30 0.000000  2.386667  2.736842
         2009-03-19T20:40 0.000000  1.746667  2.210526
         2009-03-19T20:50 0.000000  1.680000  2.105263
         2009-03-19T21:00 0.000000  1.546667  1.947368
         2009-03-19T21:10 0.000000  1.520000  2.052632
         2009-03-19T21:20 0.000000  1.520000  1.921053
         2009-03-19T21:30 0.000000  1.386667  1.921053
         2009-03-19T21:40 0.000000  1.466667  1.973684
         2009-03-19T21:50 0.000000  1.053333  1.184211
         2009-03-19T22:00 0.000000  0.973333  1.631579
         2009-03-19T22:10 0.000000  1.746667  2.342105
         2009-03-19T22:20 0.000000  1.866667  2.815789
         2009-03-19T22:30 0.000000  1.546667  2.000000
         2009-03-19T22:40 0.000000  1.640000  1.842105
         2009-03-19T22:50 0.000000  1.693333  1.947368
         2009-03-19T23:00 0.000000  1.466667  1.710526
         2009-03-19T23:10 0.000000  1.613333  2.131579
         2009-03-19T23:20 0.000000  2.146667  2.421053
         2009-03-19T23:30 0.000000  1.586667  2.078947
         2009-03-19T23:40 0.000000  0.840000  1.500000
         2009-03-19T23:50 0.000000  1.453333  2.026316
         2009-03-20T00:00 0.000000  1.746667  2.078947
         2009-03-20T00:10 0.000000  1.120000  1.631579
         2009-03-20T00:20 0.000000  0.400000  0.421053
         2009-03-20T00:30 0.000000  0.520000  1.026316
         2009-03-20T00:40 0.000000  0.786667  1.342105
         2009-03-20T00:50 0.000000  0.733333  1.394737
         2009-03-20T01:00 0.000000  0.506667  1.026316
         2009-03-20T01:10 0.000000  0.866667  1.552632
         2009-03-20T01:20 0.000000  0.413333  0.684211
         2009-03-20T01:30 0.000000  0.400000  0.394737
         2009-03-20T01:40 0.000000  0.426667  0.763158
         2009-03-20T01:50 0.000000  0.400000  0.394737
         2009-03-20T02:00 0.000000  0.400000  0.394737
         2009-03-20T02:10 0.000000  0.400000  0.394737
         2009-03-20T02:20 0.000000  0.400000  0.394737
         2009-03-20T02:30 0.000000  0.400000  0.394737
         2009-03-20T02:40 0.000000  0.480000  0.842105
         2009-03-20T02:50 0.000000  1.066667  2.315789
         2009-03-20T03:00 0.000000  1.280000  2.947368
         2009-03-20T03:10 0.000000  1.706667  2.105263
         2009-03-20T03:20 0.000000  2.133333  3.131579
         2009-03-20T03:30 0.000000  2.093333  2.763158
         2009-03-20T03:40 0.000000  2.040000  2.842105
         2009-03-20T03:50 0.000000  1.986667  3.052632
         2009-03-20T04:00 0.000000  1.826667  2.842105
         2009-03-20T04:10 0.000000  1.573333  2.842105
         2009-03-20T04:20 0.000000  1.906667  2.921053
         2009-03-20T04:30 0.000000  1.973333  2.947368
         2009-03-20T04:40 0.000000  1.960000  3.157895
         2009-03-20T04:50 0.000000  2.053333  2.789474
         2009-03-20T05:00 0.000000  2.213333  3.078947
         2009-03-20T05:10 0.000000  1.466667  3.052632
         2009-03-20T05:20 0.000000  1.506667  3.263158
         2009-03-20T05:30 0.000000  2.266667  2.868421
         2009-03-20T05:40 0.000000  1.840000  2.578947
         2009-03-20T05:50 0.000000  1.866667  2.447368
         2009-03-20T06:00 0.000000  1.066667  2.026316
         2009-03-20T06:10 0.000000  0.586667  1.315789
         2009-03-20T06:20 0.000000  1.040000  1.500000
         2009-03-20T06:30 0.000000  0.546667  1.026316
         2009-03-20T06:40 0.000000  0.720000  2.000000
         2009-03-20T06:50 0.000000  0.853333  1.973684
         2009-03-20T07:00 0.000000  1.186667  1.710526
         2009-03-20T07:10 0.000000  2.160000  3.026316
         2009-03-20T07:20 0.000000  2.306667  3.131579
         2009-03-20T07:30 0.000000  2.280000  3.447368
         2009-03-20T07:40 0.000000  1.906667  2.815789
         2009-03-20T07:50 0.000000  2.493333  4.052632
         2009-03-20T08:00 0.000000  2.546667  4.026316
         2009-03-20T08:10 0.000000  2.773333  3.815789
         2009-03-20T08:20 0.000000  2.480000  3.842105
         2009-03-20T08:30 0.000000  2.373333  3.500000
         2009-03-20T08:40 0.000000  2.373333  3.605263
         2009-03-20T08:50 0.000000  2.746667  3.789474
         2009-03-20T09:00 0.000000  2.960000  4.078947
         2009-03-20T09:10 0.000000  2.866667  4.447368
         2009-03-20T09:20 0.000000  3.266667  4.500000
         2009-03-20T09:30 0.000000  2.360000  3.973684
         2009-03-20T09:40 0.000000  2.373333  4.789474
         2009-03-20T09:50 0.000000  3.066667  4.763158
         2009-03-20T10:00 0.000000  3.653333  5.421053
         2009-03-20T10:10 0.000000  3.600000  5.526316
         2009-03-20T10:20 0.000000  2.640000  5.052632
         2009-03-20T10:30 0.000000  3.400000  6.026316
         2009-03-20T10:40 0.000000  3.680000  5.184211
         2009-03-20T10:50 0.000000  4.013333  6.026316
         2009-03-20T11:00 0.000000  4.226667  6.631579
         2009-03-20T11:10 0.000000  2.706667  5.657895
         2009-03-20T11:20 0.000000  3.600000  5.131579
         2009-03-20T11:30 0.000000  4.693333  7.052632
         2009-03-20T11:40 0.000000  4.560000  6.078947
         2009-03-20T11:50 0.000000  4.306667  6.394737
         2009-03-20T12:00 0.000000  4.066667  6.236842
         2009-03-20T12:10 0.000000  4.133333  5.868421
         2009-03-20T12:20 0.000000  4.146667  6.394737
         2009-03-20T12:30 0.000000  4.466667  6.000000
         2009-03-20T12:40 0.000000  4.946667  7.184211
         """)

simple_data1 = textwrap.dedent("""\
         09/03/19 20:10:00 0.000000  2.413333  2.710526
         09/03/19 20:20:00 0.000000  2.320000  2.578947

         09/03/19 20:30:00 0.000000  2.386667  2.736842
         09/03/19 20:40:00 0.000000  1.746667  2.210526

         09/03/19 20:50:00 0.000000  1.680000  2.105263
         09/03/19 21:00:00 0.000000  1.546667  1.947368
         09/03/19 21:10:00 0.000000  1.520000  2.052632
         09/03/19 21:20:00 0.000000  1.520000  1.921053
         09/03/19 21:30:00 0.000000  1.386667  1.921053
         09/03/19 21:40:00 0.000000  1.466667  1.973684
         09/03/19 21:50:00 0.000000  1.053333  1.184211
         09/03/19 22:00:00 0.000000  0.973333  1.631579
         09/03/19 22:10:00 0.000000  1.746667  2.342105
         09/03/19 22:20:00 0.000000  1.866667  2.815789
         09/03/19 22:30:00 0.000000  1.546667  2.000000
         09/03/19 22:40:00 0.000000  1.640000  1.842105
         09/03/19 22:50:00 0.000000  1.693333  1.947368
         09/03/19 23:00:00 0.000000  1.466667  1.710526
         09/03/19 23:10:00 0.000000  1.613333  2.131579
         09/03/19 23:20:00 0.000000  2.146667  2.421053
         09/03/19 23:30:00 0.000000  1.586667  2.078947
         09/03/19 23:40:00 0.000000  0.840000  1.500000
         09/03/19 23:50:00 0.000000  1.453333  2.026316
         09/03/20 00:00:00 0.000000  1.746667  2.078947
         09/03/20 00:10:00 0.000000  1.120000  1.631579
         09/03/20 00:20:00 0.000000  0.400000  0.421053
         09/03/20 00:30:00 0.000000  0.520000  1.026316
         09/03/20 00:40:00 0.000000  0.786667  1.342105
         09/03/20 00:50:00 0.000000  0.733333  1.394737
         09/03/20 01:00:00 0.000000  0.506667  1.026316
         09/03/20 01:10:00 0.000000  0.866667  1.552632
         09/03/20 01:20:00 0.000000  0.413333  0.684211
         09/03/20 01:30:00 0.000000  0.400000  0.394737
         09/03/20 01:40:00 0.000000  0.426667  0.763158
         09/03/20 01:50:00 0.000000  0.400000  0.394737
         09/03/20 02:00:00 0.000000  0.400000  0.394737
         09/03/20 02:10:00 0.000000  0.400000  0.394737
         09/03/20 02:20:00 0.000000  0.400000  0.394737
         09/03/20 02:30:00 0.000000  0.400000  0.394737
         09/03/20 02:40:00 0.000000  0.480000  0.842105
         09/03/20 02:50:00 0.000000  1.066667  2.315789
         09/03/20 03:00:00 0.000000  1.280000  2.947368
         09/03/20 03:10:00 0.000000  1.706667  2.105263
         09/03/20 03:20:00 0.000000  2.133333  3.131579
         09/03/20 03:30:00 0.000000  2.093333  2.763158
         09/03/20 03:40:00 0.000000  2.040000  2.842105
         09/03/20 03:50:00 0.000000  1.986667  3.052632
         09/03/20 04:00:00 0.000000  1.826667  2.842105
         09/03/20 04:10:00 0.000000  1.573333  2.842105
         09/03/20 04:20:00 0.000000  1.906667  2.921053
         09/03/20 04:30:00 0.000000  1.973333  2.947368
         09/03/20 04:40:00 0.000000  1.960000  3.157895
         09/03/20 04:50:00 0.000000  2.053333  2.789474
         09/03/20 05:00:00 0.000000  2.213333  3.078947
         09/03/20 05:10:00 0.000000  1.466667  3.052632
         09/03/20 05:20:00 0.000000  1.506667  3.263158
         09/03/20 05:30:00 0.000000  2.266667  2.868421
         09/03/20 05:40:00 0.000000  1.840000  2.578947
         09/03/20 05:50:00 0.000000  1.866667  2.447368
         09/03/20 06:00:00 0.000000  1.066667  2.026316
         09/03/20 06:10:00 0.000000  0.586667  1.315789
         09/03/20 06:20:00 0.000000  1.040000  1.500000
         09/03/20 06:30:00 0.000000  0.546667  1.026316
         09/03/20 06:40:00 0.000000  0.720000  2.000000
         09/03/20 06:50:00 0.000000  0.853333  1.973684
         09/03/20 07:00:00 0.000000  1.186667  1.710526
         09/03/20 07:10:00 0.000000  2.160000  3.026316
         09/03/20 07:20:00 0.000000  2.306667  3.131579
         09/03/20 07:30:00 0.000000  2.280000  3.447368
         09/03/20 07:40:00 0.000000  1.906667  2.815789
         09/03/20 07:50:00 0.000000  2.493333  4.052632
         09/03/20 08:00:00 0.000000  2.546667  4.026316
         09/03/20 08:10:00 0.000000  2.773333  3.815789
         09/03/20 08:20:00 0.000000  2.480000  3.842105
         09/03/20 08:30:00 0.000000  2.373333  3.500000
         09/03/20 08:40:00 0.000000  2.373333  3.605263
         09/03/20 08:50:00 0.000000  2.746667  3.789474
         09/03/20 09:00:00 0.000000  2.960000  4.078947
         09/03/20 09:10:00 0.000000  2.866667  4.447368
         09/03/20 09:20:00 0.000000  3.266667  4.500000
         09/03/20 09:30:00 0.000000  2.360000  3.973684
         09/03/20 09:40:00 0.000000  2.373333  4.789474
         09/03/20 09:50:00 0.000000  3.066667  4.763158
         09/03/20 10:00:00 0.000000  3.653333  5.421053
         09/03/20 10:10:00 0.000000  3.600000  5.526316
         09/03/20 10:20:00 0.000000  2.640000  5.052632
         09/03/20 10:30:00 0.000000  3.400000  6.026316
         09/03/20 10:40:00 0.000000  3.680000  5.184211
         09/03/20 10:50:00 0.000000  4.013333  6.026316
         09/03/20 11:00:00 0.000000  4.226667  6.631579
         09/03/20 11:10:00 0.000000  2.706667  5.657895
         09/03/20 11:20:00 0.000000  3.600000  5.131579
         09/03/20 11:30:00 0.000000  4.693333  7.052632
         09/03/20 11:40:00 0.000000  4.560000  6.078947
         09/03/20 11:50:00 0.000000  4.306667  6.394737
         09/03/20 12:00:00 0.000000  4.066667  6.236842
         09/03/20 12:10:00 0.000000  4.133333  5.868421
         09/03/20 12:20:00 0.000000  4.146667  6.394737
         09/03/20 12:30:00 0.000000  4.466667  6.000000
         09/03/20 12:40:00 0.000000  4.946667  7.184211
         """)

simple_data2 = textwrap.dedent("""\
         19/03/2009	20:10:00	0.000000	2.413333	  2.710526
         19/03/2009	20:20:00	0.000000	2.320000	  2.578947
         19/03/2009	20:30:00	0.000000	2.386667	  2.736842
         19/03/2009	20:40:00	0.000000	1.746667	  2.210526
         19/03/2009	20:50:00	0.000000	1.680000	  2.105263
         19/03/2009	21:00:00	0.000000	1.546667	  1.947368
         19/03/2009	21:10:00	0.000000	1.520000	  2.052632
         19/03/2009	21:20:00	0.000000	1.520000	  1.921053
         19/03/2009	21:30:00	0.000000	1.386667	  1.921053
         19/03/2009	21:40:00	0.000000	1.466667	  1.973684
         19/03/2009	21:50:00	0.000000	1.053333	  1.184211
         19/03/2009	22:00:00	0.000000	0.973333	  1.631579
         19/03/2009	22:10:00	0.000000	1.746667	  2.342105
         19/03/2009	22:20:00	0.000000	1.866667	  2.815789
         19/03/2009	22:30:00	0.000000	1.546667	  2.000000
         19/03/2009	22:40:00	0.000000	1.640000	  1.842105
         19/03/2009	22:50:00	0.000000	1.693333	  1.947368
         19/03/2009	23:00:00	0.000000	1.466667	  1.710526
         19/03/2009	23:10:00	0.000000	1.613333	  2.131579
         19/03/2009	23:20:00	0.000000	2.146667	  2.421053
         19/03/2009	23:30:00	0.000000	1.586667	  2.078947
         19/03/2009	23:40:00	0.000000	0.840000	  1.500000
         19/03/2009	23:50:00	0.000000	1.453333	  2.026316
         20/03/2009	00:00:00	0.000000	1.746667	  2.078947
         20/03/2009	00:10:00	0.000000	1.120000	  1.631579
         20/03/2009	00:20:00	0.000000	0.400000	  0.421053
         20/03/2009	00:30:00	0.000000	0.520000	  1.026316
         20/03/2009	00:40:00	0.000000	0.786667	  1.342105
         20/03/2009	00:50:00	0.000000	0.733333	  1.394737
         20/03/2009	01:00:00	0.000000	0.506667	  1.026316
         20/03/2009	01:10:00	0.000000	0.866667	  1.552632
         20/03/2009	01:20:00	0.000000	0.413333	  0.684211
         20/03/2009	01:30:00	0.000000	0.400000	  0.394737
         20/03/2009	01:40:00	0.000000	0.426667	  0.763158
         20/03/2009	01:50:00	0.000000	0.400000	  0.394737
         20/03/2009	02:00:00	0.000000	0.400000	  0.394737
         20/03/2009	02:10:00	0.000000	0.400000	  0.394737
         20/03/2009	02:20:00	0.000000	0.400000	  0.394737
         20/03/2009	02:30:00	0.000000	0.400000	  0.394737
         20/03/2009	02:40:00	0.000000	0.480000	  0.842105
         20/03/2009	02:50:00	0.000000	1.066667	  2.315789
         20/03/2009	03:00:00	0.000000	1.280000	  2.947368
         20/03/2009	03:10:00	0.000000	1.706667	  2.105263
         20/03/2009	03:20:00	0.000000	2.133333	  3.131579
         20/03/2009	03:30:00	0.000000	2.093333	  2.763158
         20/03/2009	03:40:00	0.000000	2.040000	  2.842105
         20/03/2009	03:50:00	0.000000	1.986667	  3.052632
         20/03/2009	04:00:00	0.000000	1.826667	  2.842105
         20/03/2009	04:10:00	0.000000	1.573333	  2.842105
         20/03/2009	04:20:00	0.000000	1.906667	  2.921053
         20/03/2009	04:30:00	0.000000	1.973333	  2.947368
         20/03/2009	04:40:00	0.000000	1.960000	  3.157895
         20/03/2009	04:50:00	0.000000	2.053333	  2.789474
         20/03/2009	05:00:00	0.000000	2.213333	  3.078947
         20/03/2009	05:10:00	0.000000	1.466667	  3.052632
         20/03/2009	05:20:00	0.000000	1.506667	  3.263158
         20/03/2009	05:30:00	0.000000	2.266667	  2.868421
         20/03/2009	05:40:00	0.000000	1.840000	  2.578947
         20/03/2009	05:50:00	0.000000	1.866667	  2.447368
         20/03/2009	06:00:00	0.000000	1.066667	  2.026316
         20/03/2009	06:10:00	0.000000	0.586667	  1.315789
         20/03/2009	06:20:00	0.000000	1.040000	  1.500000
         20/03/2009	06:30:00	0.000000	0.546667	  1.026316
         20/03/2009	06:40:00	0.000000	0.720000	  2.000000
         20/03/2009	06:50:00	0.000000	0.853333	  1.973684
         20/03/2009	07:00:00	0.000000	1.186667	  1.710526
         20/03/2009	07:10:00	0.000000	2.160000	  3.026316
         20/03/2009	07:20:00	0.000000	2.306667	  3.131579
         20/03/2009	07:30:00	0.000000	2.280000	  3.447368
         20/03/2009	07:40:00	0.000000	1.906667	  2.815789
         20/03/2009	07:50:00	0.000000	2.493333	  4.052632
         20/03/2009	08:00:00	0.000000	2.546667	  4.026316
         20/03/2009	08:10:00	0.000000	2.773333	  3.815789
         20/03/2009	08:20:00	0.000000	2.480000	  3.842105
         20/03/2009	08:30:00	0.000000	2.373333	  3.500000
         20/03/2009	08:40:00	0.000000	2.373333	  3.605263
         20/03/2009	08:50:00	0.000000	2.746667	  3.789474
         20/03/2009	09:00:00	0.000000	2.960000	  4.078947
         20/03/2009	09:10:00	0.000000	2.866667	  4.447368
         20/03/2009	09:20:00	0.000000	3.266667	  4.500000
         20/03/2009	09:30:00	0.000000	2.360000	  3.973684
         20/03/2009	09:40:00	0.000000	2.373333	  4.789474
         20/03/2009	09:50:00	0.000000	3.066667	  4.763158
         20/03/2009	10:00:00	0.000000	3.653333	  5.421053
         20/03/2009	10:10:00	0.000000	3.600000	  5.526316
         20/03/2009	10:20:00	0.000000	2.640000	  5.052632
         20/03/2009	10:30:00	0.000000	3.400000	  6.026316
         20/03/2009	10:40:00	0.000000	3.680000	  5.184211
         20/03/2009	10:50:00	0.000000	4.013333	  6.026316
         20/03/2009	11:00:00	0.000000	4.226667	  6.631579
         20/03/2009	11:10:00	0.000000	2.706667	  5.657895
         20/03/2009	11:20:00	0.000000	3.600000	  5.131579
         20/03/2009	11:30:00	0.000000	4.693333	  7.052632
         20/03/2009	11:40:00	0.000000	4.560000	  6.078947
         20/03/2009	11:50:00	0.000000	4.306667	  6.394737
         20/03/2009	12:00:00	0.000000	4.066667	  6.236842
         20/03/2009	12:10:00	0.000000	4.133333	  5.868421
         20/03/2009	12:20:00	0.000000	4.146667	  6.394737
         20/03/2009	12:30:00	0.000000	4.466667	  6.000000
         20/03/2009	12:40:00	0.000000	4.946667	  7.184211
         """)


class RequestWithMethod(Request):
    """
    See http://benjamin.smedbergs.us/blog/2008-10-21/putting-and-deleteing-in-python-urllib2/
    """
    def __init__(self, method, *args, **kwargs):
        self._method = method
        Request.__init__(self, *args, **kwargs)

    def get_method(self):
        return self._method


_connection_instructions = """
Omitting the tests for meteologger; in order to run these tests, you
must specify the PTHELMA_TEST_METEOLOGGER variable to contain a
json-formatted string of parameters, like this (but it may be in one
line):

    { "base_url": "http://localhost:8001/",
      "username": "admin",
      "password": "secret",
      "station_id": 1334,
      "variable_id": 1,
      "unit_of_measurement_id": 1,
      "time_zone_id": 1 }

The first three parameters are for connecting to an appropriate
database. Don't use a production database for that; although things
are normally cleaned up (e.g. test timeseries created are deleted), id
serial numbers will be affected and things might not be cleaned up if
there is an error.

The rest of the parameters are used when test timeseries are created.
"""

class _Test_logger(unittest.TestCase):
    class_being_tested = None
    testdata = None
    datafiledict = {}
    ref_ts1 = Timeseries(0)
    ref_ts1.read(StringIO(timeseries1))
    ref_ts2 = Timeseries(0)
    ref_ts2.read(StringIO(timeseries2))
    base_url = None
    try:
        __v = json.loads(os.getenv("PTHELMA_TEST_METEOLOGGER"))
        base_url = __v['base_url']
        username = __v['username']
        password = __v['password']
        station_id = __v['station_id']
        variable_id = __v['variable_id']
        unit_of_measurement_id = __v['unit_of_measurement_id']
        time_zone_id = __v['time_zone_id']
    except TypeError:
        sys.stderr.write(_connection_instructions)

    def setUp(self):

        if not self.class_being_tested or not self.base_url:
            return

        # First 60 nonempty lines of test go to self.file1
        (fd, self.file1) = tempfile.mkstemp(text=True)
        fp = os.fdopen(fd, 'w')
        i = 0
        for line in StringIO(self.testdata):
            if i>=60: break
            if not line.strip(): continue
            i += 1
            fp.write(line)
        fp.close()

        # All lines of test go to self.file2
        (fd, self.file2) = tempfile.mkstemp(text=True)
        fp = os.fdopen(fd, 'w')
        fp.write(self.testdata)
        fp.close

        # Connect to server
        cookiejar = cookielib.CookieJar()
        self.opener = build_opener(HTTPCookieProcessor(cookiejar))
        self.opener.open(self.base_url + 'accounts/login/').read()
        self.opener.addheaders = [('X-CSRFToken', cookie.value)
                                  for cookie in cookiejar
                                  if cookie.name == 'csrftoken']
        data = 'username={0}&password={1}'.format(self.username, self.password)
        self.opener.open(self.base_url + 'accounts/login/', data)

        # Create two timeseries
        self.timeseries_id1 = self._create_timeseries()
        self.timeseries_id2 = self._create_timeseries()
        self.datafile_fields = "0,{0},{1}".format(self.timeseries_id1,
                                                  self.timeseries_id2)
        self.ts1 = Timeseries(self.timeseries_id1)
        self.ts2 = Timeseries(self.timeseries_id2)

    def tearDown(self):
        if not self.class_being_tested or not self.base_url:
            return
        self._delete_timeseries(self.timeseries_id2)
        self._delete_timeseries(self.timeseries_id1)

    def _create_timeseries(self):
        # Create a timeseries on the server and return its id
        j = { 'gentity': self.station_id,
              'variable': self.variable_id,
              'unit_of_measurement': self.unit_of_measurement_id,
              'time_zone': self.time_zone_id,
            }
        r = Request(self.base_url + 'api/Timeseries/', data=json.dumps(j),
                    headers = { 'Content-type': 'application/json' })
        fp = self.opener.open(r)
        response_text = fp.read()
        return json.loads(response_text)['id']

    def _delete_timeseries(self, ts_id):
        url = self.base_url + 'api/Timeseries/{0}/'.format(ts_id)
        r = RequestWithMethod('DELETE', url)
        try:
            self.opener.open(r)
            # According to the theory at
            # http://stackoverflow.com/questions/7032890/ and elsewhere,
            # we shouldn't reach this point; in practice, however, I see
            # that a 204 response results in coming here, not in raising an
            # exception (and with no way to check the status code). I assume
            # that if we come here everything was OK.
        except HTTPError as e:
            # But just to be sure, also assume that a 204 response might
            # lead us here as well.
            if e.code != 204:
                raise

    def _read_timeseries(self, ts):
        r = Request(self.base_url + 'api/tsdata/{0}/'.format(ts.id))
        fp = self.opener.open(r)
        ts.read(fp)
        
    def runTest(self):
        if not self.class_being_tested or not self.base_url:
            return
        d = { 'filename': self.file1,
              'datafile_fields': self.datafile_fields,
            }
        d.update(self.datafiledict)
        df = self.class_being_tested(self.base_url, self.opener, d)
        df.update_database()
        self._read_timeseries(self.ts1)
        self._read_timeseries(self.ts2)
        self.assertEqual(len(self.ts1), 60)
        self.assertEqual(len(self.ts2), 60)
        (items1, items2, ritems1, ritems2) = [ x.items() for x in (self.ts1,
                                        self.ts2, self.ref_ts1, self.ref_ts2)]
        for i in range(0, 60):
            self.assertEqual(items1[i][0], ritems1[i][0])
            self.assertAlmostEqual(items1[i][1], ritems1[i][1], 4)
            self.assertEqual(items1[i][1].flags, ritems1[i][1].flags)
            self.assertEqual(items2[i][0], ritems2[i][0])
            self.assertAlmostEqual(items2[i][1], ritems2[i][1], 4)
            self.assertEqual(items2[i][1].flags, ritems2[i][1].flags)
        d['filename'] = self.file2
        df = self.class_being_tested(self.base_url, self.opener, d)
        df.update_database()
        self._read_timeseries(self.ts1)
        self._read_timeseries(self.ts2)
        self.assertEqual(len(self.ts1), 100)
        self.assertEqual(len(self.ts2), 100)
        (items1, items2, ritems1, ritems2) = [ x.items() for x in (self.ts1,
                                       self.ts2, self.ref_ts1, self.ref_ts2)]
        for i in range(0, 100):
            self.assertEqual(items1[i][0], ritems1[i][0])
            self.assertAlmostEqual(items1[i][1], ritems1[i][1], 4)
            self.assertEqual(items1[i][1].flags, ritems1[i][1].flags)
            self.assertEqual(items2[i][0], ritems2[i][0])
            self.assertAlmostEqual(items2[i][1], ritems2[i][1], 4)
            self.assertEqual(items2[i][1].flags, ritems2[i][1].flags)


class _Test_deltacom(_Test_logger):
    testdata = deltacom_data
    class_being_tested = Datafile_deltacom


class _Test_simple1(_Test_logger):
    testdata = simple_data1
    class_being_tested = Datafile_simple
    datafiledict = { 'date_format': '%y/%m/%d %H:%M:%S', }


class _Test_simple2(_Test_logger):
    testdata = simple_data2
    class_being_tested = Datafile_simple
    datafiledict = { 'date_format': '%d/%m/%Y %H:%M:%S', }
